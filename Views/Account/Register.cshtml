@using IndustrialContoroler.ViewModel
@using Microsoft.AspNetCore.Identity
@inject IHttpContextAccessor _sessions
@inject IndustrialContorolerDatabaseContext _context
@model UserVM


@{
int counter = 1;
    ViewData["Roles"] = new Microsoft.AspNetCore.Mvc.Rendering.SelectList(_context.Roles.Where(x => x.Name != @Helper.Progreammer), "Name", "Name");

}
    <h3 style="font-family: 'Almarai', sans-serif; font-size:20px;  background-color: rgb(82, 134, 203); color: azure;" class=" card-header py-3 mb-10 "><img class="me-3" src="~/img/report25.png" alt=""> ادارة المستخدمين </h3>

    
    <div class="card-body">
        <!-- Ajax Sourced Server-side -->
      

            <div class="card m-3 mb-5">
               
                <div class="table-responsive m">
               
                     <a style="font-family: 'Almarai', sans-serif; font-size:16px; color:white;" class="btn btn-primary gradient-buttons h-px-35 my-3 mx-3  col-md-2" role="button" data-bs-toggle="offcanvas"
                       data-bs-target="#addNewuser" onclick="Rest()">
                        <i class="fas fa-plus" style=" font-size: small;"></i> إنشاء مستخدم
                    </a>
                   

                
                  <table  class="datatables-ajax table table-bordered table-hover">
                        <thead >
                                 <tr >
                                   <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col">الرقم</th>
                                
                                <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col" >اسم الموظف</th>
                                <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col">اسم المستخدم</th>
@*                                <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col">@ResourceWeb.lbImageUser</th>
*@                                <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col">اللاكتروني</th>
                                 
                                <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col">الصلاحية</th>
                                <th style="font-family: 'Almarai', sans-serif; font-size:16px;" scope="col">الأجرائات</th>

                                </tr>


                        </thead>
           @if (Model.Users is not null)
                {

                   
                <tbody style="font-family: 'Cairo', sans-serif; font-size:14px;" class="table-border-bottom-0">
                             @foreach (var item in Model.Users)
                    {
                            if (item.Role != Helper.Progreammer)
                            {
                                <tr>

                                    <td><span class="text-center">  </span>@counter </td>

                                    <td><span class="text-center"> @item.FullName </span> </td>
                                    <td >
                                        <span class="text-center"> @item.UserName </span>
                                    </td>



                                    <td>
                                        <span class="text-center"> @item.Email</span>
                                    </td>


                                    <td ><span class="text-center"> @item.Role</span></td>


                                    <td>
                                        <div class="dropdown">
                                            <button type="button" class="btn dropdown-toggle hide-arrow p-0" data-bs-toggle="dropdown">
                                                <i class="bx bx-dots-vertical-rounded"></i>
                                            </button>
                                            <div class="dropdown-menu">

                                                <button class="dropdown-item" data-bs-toggle="offcanvas" data-bs-target="#addNewuser"
                                                        onclick="Edit('@item.Id', '@item.FullName','@item.UserName','@item.PhoneNumber','@item.Email','@item.ImageUser','@item.Role','@item.ActiveUser')">
                                                    <i class="bx bx-pencil  me-1"></i>@ResourceWeb.lbbtnEdit
                                                </button>
                                                <button class="dropdown-item" data-bs-toggle="modal" data-bs-target="#DeleteModel" onclick="Delete('@item.Id')">
                                                    <i class="bx bx-trash me-1"></i> @ResourceWeb.lbbtnDelete
                                                </button>
                                                <button class="dropdown-item" data-bs-toggle="offcanvas" data-bs-target="#changePasswordModal" onclick="ChangePassword('@item.Id')">
                                                    <i class="bx bx-pencil  me-1"></i> @ResourceWeb.lbbtnChangePassword
                                                </button>


                                            </div>

                                        </div>
                                    </td>
                                </tr>
                                counter = counter + 1;

                            }
                        }
                        </tbody>
                    





                }
                    </table>


            
                </div>

              </div>
           </div>


            <!--------------------application-->
            <!--------------------application-->
            <div class="offcanvas offcanvas-end" tabindex="-1" id="addNewuser"
                 aria-labelledby="offcanvasAddUserLabel">
                <div class="offcanvas-header border-bottom">
                    <h6 style="font-family: 'Cairo', sans-serif; font-size:20px;" id="title"  class="offcanvas-title">@ResourceWeb.lbbtnSaveNewUser</h6>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                            aria-label="Close"></button>
                </div>
                <div class="offcanvas-body flex-grow-0 mx-0">

                    <form  asp-action="Register" asp-controller="Account"  method="post" enctype="multipart/form-data">
                            
                        <div class="mb-3">
                            <input type="text" hidden class="form-control" asp-for="newRegister.Id" id="userId" />
                            <input type="text" hidden class="form-control" asp-for="newRegister.ImageUser" id="imgeHide" />
                            <label class="form-label" style="font-family: 'Cairo', sans-serif; font-size:14px;" asp-for="newRegister.FullName">اسم الموضف</label>
                            <input asp-for="newRegister.FullName" class="form-control" id="fullName" style="font-family: 'Almarai', sans-serif; font-size:14px;">
                            <span class="alert-danger" asp-validation-for="newRegister.FullName"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="font-family: 'Cairo', sans-serif; font-size:14px;"  asp-for="newRegister.UserName">اسم المستخدم</label>

                            <input asp-for="newRegister.UserName" id="userName" class="form-control" style="font-family: 'Almarai', sans-serif; font-size:14px;" />
                            <span class="alert-danger" asp-validation-for="newRegister.UserName"></span>
                        </div>

                        <div class="mb-3 fv-plugins-icon-container">
                            <label class="form-label" asp-for="newRegister.PhoneNumber" style="font-family: 'Cairo', sans-serif; font-size:14px;">رقم التلفون</label>
                            <div class="input-group input-group-merge">
                            <span class="input-group-text">Ye (+967)</span>
                            <input type="tel" maxlength="9" asp-for="newRegister.PhoneNumber" id="userPhone" class="form-control phone-mask" placeholder="" style="font-family: 'Almarai', sans-serif; font-size:14px;">
                            
                            </div>  
                            <span class="alert-danger" asp-validation-for="newRegister.PhoneNumber"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" asp-for="newRegister.Email" style="font-family: 'Cairo', sans-serif; font-size:14px;">البريد الإلكتروني</label>

                            <input asp-for="newRegister.Email" id="userEmail" class="form-control" placeholder="username@gmail.com" style="font-family: 'Cairo', sans-serif; font-size:14px;">
                            <span class="alert-danger" asp-validation-for="newRegister.Email"></span>
                        </div>
                        <div class="form-password-toggle mb-3" id="grPassword">
                            <label class="form-label" asp-for="newRegister.Password"  style="font-family: 'Cairo', sans-serif; font-size:14px;">كلمة السر</label>
                            <div class="input-group input-group-merge">
                                <input type="password" id="userPassword" class="form-control"
                                       asp-for="newRegister.Password" placeholder="***********" style="font-family: 'Cairo', sans-serif; font-size:14px;"/>
                                       
                                
                            </div>
                            <span class="alert-danger" asp-validation-for="newRegister.Password"></span>
                        </div>

                        <div class="form-password-toggle mb-3" id="grcomPassword">
                            <label class="form-label" asp-for="newRegister.ConfirmPassword" style="font-family: 'Cairo', sans-serif; font-size:14px;">تأكيد كلمة السر</label>
                            <div class="input-group input-group-merge">
                                <input type="password" id="userCompare" class="form-control"
                                       asp-for="newRegister.ConfirmPassword" placeholder="***********" style="font-family: 'Cairo', sans-serif; font-size:14px;" />
                            </div>
                           <span class="alert-danger" asp-validation-for="newRegister.ConfirmPassword"></span>

                        </div>

                        <div class="mb-3">
                            <img src="@Helper.PathImageuser/@Model.newRegister.ImageUser" class="img-circle"
                                 style="width:35px;height:35px" hidden id="image" />

                        </div>


                        <div class="mb-3">
                            <label class="form-label" asp-for="newRegister.ImageUser" style="font-family: 'Cairo', sans-serif; font-size:14px;">الصورة</label>
                            <input type="file" class="form-control" asp-for="newRegister.ImageUser" style="font-family: 'Cairo', sans-serif; font-size:14px;"
                             accept=".jpg,.jpeg,.png,.PNG,.JPG,.JPEG" id="userImage" placeholder="اختار صورة" />
                            <span class="alert-danger" asp-validation-for="newRegister.ImageUser"></span>
                        </div>

                            



                      

                          <div class="row">
                            <label  asp-for="newRegister.RoleName" style="font-size:medium; font-weight: bold;" class="col-form-label col-md-3 text-sm-end">الصلاحية </label>
                            <div class="col-sm-9">
                            <select class="selectpicker w-100" asp-for="newRegister.RoleName" id="ddluserRole" style="font-family: 'Almarai', sans-serif; font-size:14px;"
                                     >
                             @foreach (var role in ViewData["Roles"] as SelectList)
                                        {
                                            <option value="@role.Value" style="font-family: 'Cairo', sans-serif; font-size:14px;" > @role.Text</option>
                                        }
                        
                    </select>
                            <span class="alert-danger" asp-validation-for="newRegister.RoleName"></span>


                        </div>
                        </div>


                        <div class="mb-3" hidden>
                            <label class="form-label" asp-for="newRegister.ActiveUser">تفعيل المستخدم</label>
                            <input asp-for="newRegister.ActiveUser" type="checkbox" id="userActive" class="form-check-input" />
                        </div>






                        <input type="submit" class="btn btn-primary data-submit me-1 me-sm-3 d-grid w-100 my-2" id="btnSave" value="@ResourceWeb.lbbtnSave"  />
                        <button type="reset" class="btn btn-label-secondary d-grid w-100"
                                data-bs-dismiss="offcanvas">
                            إلغاء
                        </button>
                    </form>
                </div>
            </div>
            <!--/ Ajax Sourced Server-side -->


    

        <!-------------------------------------->
        <!-- Modal Change Password -->

        <div class="offcanvas offcanvas-end" id="changePasswordModal" aria-hidden="true" aria-labelledby="changePasswordModalLabel">
            <div class="offcanvas-header border-bottom">
            <h6 style="font-family: 'Cairo', sans-serif; font-size:20px;" class="offcanvas-title" id="title">@ResourceWeb.lbbtnChangePassword</h6>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>
            </div>
            <div class="offcanvas-body flex-grow-0 mx-0">
            <form style="font-family: 'Cairo', sans-serif; font-size:18px;" class="pt-0" id="AddUnitForm" asp-action="ChangePassword" asp-controller="Account" method="post" enctype="multipart/form-data">


                    <div class="form-password-toggle mb-3">
                        <input type="text" hidden class="form-control" asp-for="ChangePassword.Id" id="userPassId" rd.NewPasswo />
                        <label class="form-label" asp-for="ChangePassword">كلمة السر</label>
                        <div class="input-group input-group-merge">
                            <input type="password" id="userPassword" class="form-control"
                                   asp-for="ChangePassword.NewPassword" /><br />
                        </div>
                        <span asp-validation-for="ChangePassword.NewPassword" class="text-danger"></span>

                    </div>

                    <div class="form-password-toggle mb-3">
                        <label class="form-label" asp-for="ChangePassword.ComparePassword">تأكيد كلمة السر</label>
                        <div class="input-group input-group-merge">
                            <input type="password" id="userPassword" class="form-control"
                             
                                   asp-for="ChangePassword.ComparePassword" /><br />
                        </div>
                        <span asp-validation-for="ChangePassword.ComparePassword" class="text-danger"></span>

                    </div>


                    <input type="submit"
                           class="btn btn-primary data-submit me-1 me-sm-3 d-grid w-100 my-2" value="@ResourceWeb.lbbtnSave" id="btnSave" />
                    <button type="reset" class="btn btn-label-secondary d-grid w-100"
                            data-bs-dismiss="offcanvas">
                        إلغاء
                    </button>
                </form>
            </div>
        </div>


    








@section Scripts{
    @if (!string.IsNullOrEmpty(_sessions.HttpContext.Session.GetString(Helper.MsgType)))
    {
        if (_sessions.HttpContext.Session.GetString(Helper.MsgType) == Helper.Success)
        {
            <script>

                Swal.fire({
                    title: '@_sessions.HttpContext.Session.GetString(Helper.Title)',
                    text: '@Html.Raw(@_sessions.HttpContext.Session.GetString(Helper.Msg))',
                    confirmButtonText: '@ResourceWeb.lbOk',
                    icon: 'success'
                });
            </script>

        }
        else
        {
            <script>

                Swal.fire({
                    title: '@_sessions.HttpContext.Session.GetString(Helper.Title)',
                    text: '@Html.Raw(@_sessions.HttpContext.Session.GetString(Helper.Msg))',
                    confirmButtonText: '@ResourceWeb.lbOk',
                    icon: 'error'
                });
            </script>
        }
        _sessions.HttpContext.Session.SetString(Helper.MsgType, "");
    }
<script>
 $(document).ready(function () {
    $('#tableRole').DataTable({
        "autoWidth": false,
        "responsive":true
    });
});

function Delete(id) {
    Swal.fire({
        title: lbTitleMsgDelete,
        text: lbTextMsgDelete,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: lbconfirmButtonText,
        cancelButtonText: lbcancelButtonText
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = `/Account/Delete?userId=${id}`;
            Swal.fire(
                lbTitleDeletedOk,
                lbMsgDeletedOkRegister,
                lbSuccess
            )
        }
    })
}
</script>
<script>
Edit = (id, fullName, username,userphone, email, image, role, active) => {
    document.getElementById("title").innerHTML = lbTitleEdit;
    document.getElementById("btnSave").value = lbEdit;                                                                                                                              
    document.getElementById("userId").value = id;
    document.getElementById("fullName").value = fullName;
    document.getElementById("userName").value = username;
    document.getElementById("userPhone").value = userphone;
    document.getElementById("userEmail").value = email;
    /*document.getElementById("userImage").value = image;*/
    document.getElementById("ddluserRole").value = role;
    var Active = document.getElementById("userActive");
    if (active == "True")
        Active.checked = true;
    else
        Active.checked = false;
    $('#grPassword').hide();
    $('#grcomPassword').hide();
    document.getElementById("userPassword").value = "$$$$$$";
    document.getElementById("userCompare").value = "$$$$$$";
    document.getElementById("image").hidden = false;
    document.getElementById("image").src = PathImageuser + image;
    document.getElementById("imgeHide").value = image;
    
}

Rest = () => {
    document.getElementById("title").innerHTML = lbAddNewUsers;
    document.getElementById("btnSave").value = lbbtnSave;
    document.getElementById("userId").value = "";
    document.getElementById("fullName").value = "";
    document.getElementById("userName").value = "";
    document.getElementById("userPhone").value = "";
    document.getElementById("userEmail").value = "";
    document.getElementById("userImage").value = "";
    document.getElementById("ddluserRole").value = "";
    document.getElementById("userActive").checked = false;
    $('#grPassword').show();
    $('#grcomPassword').show();
    document.getElementById("userPassword").value = "";
    document.getElementById("userCompare").value = "";
    document.getElementById("image").hidden = true;
    document.getElementById("imgeHide").value = "";
   

}
</script>
<script>
function ChangePassword(id) {

    document.getElementById('userPassId').value = id;
}
</script>



    <script>

        let lbTitleEdit = '@Html.Raw(ResourceWeb.lbTitleEditUser)';
        let lbAddNewUsers = '@Html.Raw(ResourceWeb.lbAddNewUsers)';
        let lbEdit = '@Html.Raw(ResourceWeb.lbEdit)';
        let lbAddNewRole = '@Html.Raw(ResourceWeb.lbAddNewRole)';
        let lbbtnSave = '@Html.Raw(ResourceWeb.lbbtnSave)';

        let lbTitleMsgDelete = '@Html.Raw(ResourceWeb.lbbtnDelete)';
        let lbTextMsgDelete = '@Html.Raw(ResourceWeb.lbTextMsgDelete)';
        let lbconfirmButtonText = '@Html.Raw(ResourceWeb.lbconfirmButtonText)';
        let lbcancelButtonText = '@Html.Raw(ResourceWeb.lbcancelButtonText)';

        let lbTitleDeletedOk = '@Html.Raw(ResourceWeb.lbTitleDeletedOk)';
        let lbMsgDeletedOkRegister = '@Html.Raw(ResourceWeb.lbMsgDeletedOkRegister)';
        let lbSuccess = '@Html.Raw(Helper.Success)';
        let PathImageuser = '@Html.Raw(Helper.PathImageuser)';



    </script>
        }

